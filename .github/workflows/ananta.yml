name: ananta Image CI
permissions:
  contents: read
  packages: write
  id-token: write

on:
  push:
    branches:
    - 'master'
    paths:
    - '.github/workflows/ananta.yml'
    - 'installer/**'
    - 'sshconfig_to_ananta/**'
    - '!sshconfig_to_ananta/test_**'
    - 'docker-entrypoint.sh'
    - 'Dockerfile'
  schedule:
  - cron: "0 5 1-31/10 * *"
  workflow_dispatch:

env:
  ananta_repo: ${{ secrets.DOCKERHUB_USERNAME }}/ananta

jobs:
  ananta:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        variant:
          - latest
          - installer
    steps:
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: actions/checkout@v4

      - name: Build the latest variant to the local docker daemon
        uses: docker/build-push-action@v6
        with:
          load: true
          tags: ${{ env.ananta_repo }}:${{ matrix.variant }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Save the docker images as tarball
        run: |
          docker save -o "ananta.${{ matrix.variant }}.tar" "${{ env.ananta_repo }}:${{ matrix.variant }}"

      - name: Smoke Test
        if: matrix.variant == 'latest'
        run: |
          sudo apt-get update -qq \
              && sudo apt-get -y install \
                  openssh-client openssh-server \
              && sudo systemctl start ssh.service

          mkdir -p "${HOME}/.ssh/"
          ssh-keygen -t ed25519 -N '' -f "${HOME}/.ssh/ed25519"
          cat "${HOME}/.ssh/ed25519.pub" >> "${HOME}/.ssh/authorized_keys"
          cat << EEOOFF > "${HOME}/.ssh/config"
          Host localhost
              Hostname 127.0.0.1
              User $(whoami)
          EEOOFF

          today=$(date +%Y-%m-%d)
          docker tag "${{ env.ananta_repo }}:latest" "${{ env.ananta_repo }}:${today}"
          bash -x installer/dummy_ananta.sh whoami

      -
        name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.variant == 'installer' && './installer/' || '.' }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ env.ananta_repo }}:${{ matrix.variant }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      -
        name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.30.0
        with:
          input: "ananta.${{ matrix.variant }}.tar"
          format: 'table'
